import ExpandMoreIcon from '@mui/icons-material/ExpandMore'
import {
  Box,
  Typography,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Button,
  Chip
} from '@mui/material'

import formatDate from '@/lib/format-date.js'

const statuts = {
  'En activité': 'primary',
  Terminée: 'success',
  Abandonnée: 'error',
  'non renseigné': ''
}

const findBeneficiaireName = (id, beneficiaires) => {
  const bene = beneficiaires?.find(b => b.id_beneficiaire === id)
  if (!bene) {
    return 'Bénéficiaire inconnu'
  }

  return bene.raison_sociale || bene.sigle || `${bene.nom} ${bene.prenom}`
}

const ExploitationAccordion = ({exploitation, beneficiaires, handleOpenModal}) => {
  const beneficiary = findBeneficiaireName(exploitation.id_beneficiaire, beneficiaires)
  const dateLabel = `${formatDate(exploitation.date_debut) || '???'} - ${formatDate(exploitation.date_fin) || 'en cours'}`

  return (
    <Accordion sx={{mt: 1}}>
      <AccordionSummary expandIcon={<ExpandMoreIcon />}>
        <Box>
          <Typography fontWeight='bold'>
            Exploitation #{exploitation.id_exploitation}
          </Typography>
          <Typography variant='body2'>{dateLabel}</Typography>
        </Box>
      </AccordionSummary>
      <AccordionDetails>
        <Typography>
          <strong>Bénéficiaire :</strong> {beneficiary}
        </Typography>
        {exploitation.usages.length > 0 && (
          <Typography>
            <strong>Usages :</strong> {exploitation.usages.join(', ')}
          </Typography>
        )}
        {exploitation.statut && (
          <Box className='flex items-center gap-2'>
            <Typography>
              <strong>Statut :</strong>
            </Typography>
            <Chip label={exploitation.statut} color={statuts[exploitation.statut]} />
          </Box>
        )}

        {/* Bouton pour ouvrir la modale "Règles & Documents" */}
        <Box sx={{mt: 2}}>
          <Button
            variant='contained'
            onClick={() => handleOpenModal(exploitation)}
          >
            Voir Règles &amp; Documents
          </Button>
        </Box>
      </AccordionDetails>
    </Accordion>
  )
}

export default ExploitationAccordion

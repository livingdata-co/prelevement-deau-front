/* eslint-disable camelcase */
'use client'

import {useEffect, useState} from 'react'

import Input from '@codegouvfr/react-dsfr/Input'
import SearchBar from '@codegouvfr/react-dsfr/SearchBar'
import Select from '@codegouvfr/react-dsfr/SelectNext'
import dynamic from 'next/dynamic'

import ReglesForm from './regles-form.js'

import SearchAutocomplete from '@/components/form/search-autocomplete.js'
import AccordionCentered from '@/components/ui/accordion-centered.js'

const DynamicCheckbox = dynamic(
  () => import('@codegouvfr/react-dsfr/Checkbox'),
  {ssr: false}
)

function displayPreleveur(preleveur) {
  if (!preleveur) {
    return
  }

  if (preleveur.nom) {
    return `${preleveur.civilite} ${preleveur.nom} ${preleveur.prenom}`
  }

  if (preleveur.sigle) {
    return preleveur.sigle
  }

  if (preleveur.raison_sociale) {
    return preleveur.raison_sociale
  }
}

const statutsExploitation = [
  'En activité',
  'Terminée',
  'Abandonnée',
  'Non renseigné'
]

const usagesExploitation = [
  'Eau potable',
  'Agriculture',
  'Camion citerne',
  'Eau embouteillée',
  'Hydroélectricité',
  'Industrie',
  'Thermalisme',
  'Non renseigné',
  'Autre'
]

const ExploitationForm = ({exploitation, points, preleveurs, setExploitation}) => {
  const [isExpanded, setIsExpanded] = useState(exploitation?.regles.length > 0)
  const [hasUsagesChanged, setHasUsagesChanged] = useState(false)
  const initialUsages = exploitation?.usages || []
  const [usages, setUsages] = useState(exploitation?.usages || [])
  const defaultPoint = points.find(p => p.id_point === exploitation?.id_point)
  const defaultPreleveur = preleveurs.find(p => p.id_preleveur === exploitation?.id_preleveur)

  const handleUsages = (e, usage) => {
    setUsages(prev => {
      const newUsages = e.target.checked
        ? [...prev, usage]
        : prev.filter(u => u !== usage)

      setHasUsagesChanged(
        newUsages.length !== initialUsages.length
          || !newUsages.every(u => initialUsages.includes(u))
      )

      return newUsages
    })
  }

  useEffect(() => {
    if (hasUsagesChanged) {
      setExploitation(prev => ({...prev, usages}))
    }
  }, [usages, setExploitation, hasUsagesChanged])

  return (
    <div>
      <div className='w-full grid grid-cols-2 gap-4 pb-5'>
        <div className='pb-5'>
          <p className='pb-2'>Associer un point de prélèvement *</p>
          <SearchBar
            label='Rechercher un point de prélèvement'
            renderInput={({className, id, placeholder, type}) => (
              <SearchAutocomplete
                options={points.map(point => ({
                  point,
                  label: `${point.nom} - ${point.id_point}`
                }))}
                defaultValue={defaultPoint
                  ? `${defaultPoint.nom} - ${defaultPoint.id_point}`
                  : null}
                className={className}
                id={id}
                placeholder={placeholder}
                type={type}
                onChange={(e, value) => setExploitation(prev => ({
                  ...prev,
                  id_point: value?.point?.id_point
                }))}
              />
            )}
          />
        </div>
        <div className='pb-5'>
          <p className='pb-2'>Associer un préleveur *</p>
          <SearchBar
            label='Rechercher un préleveur'
            renderInput={({className, id, placeholder, type}) => (
              <SearchAutocomplete
                options={preleveurs.map(preleveur => ({
                  preleveur,
                  label: displayPreleveur(preleveur)
                }))}
                defaultValue={displayPreleveur(defaultPreleveur)}
                className={className}
                id={id}
                placeholder={placeholder}
                type={type}
                onChange={(e, value) => setExploitation(prev => ({
                  ...prev,
                  id_preleveur: value?.preleveur?.id_preleveur
                }))}
              />
            )}
          />
        </div>
      </div>
      <div className='w-full grid grid-cols-2 gap-4'>
        <Input
          label='Début de validité *'
          nativeInputProps={{
            type: 'date',
            defaultValue: exploitation?.date_debut,
            onChange: e => setExploitation(prev => ({...prev, date_debut: e.target.value}))
          }}
        />
        <Input
          label='Fin de validité'
          nativeInputProps={{
            type: 'date',
            defaultValue: exploitation?.date_fin,
            onChange: e => setExploitation(prev => ({...prev, date_fin: e.target.value}))
          }}
        />
      </div>
      <Select
        label='Statut *'
        placeholder='Sélectionner un statut'
        nativeSelectProps={{
          defaultValue: exploitation?.statut,
          onChange: e => setExploitation(prev => ({
            ...prev,
            statut: e.target.value
          }))
        }}
        options={statutsExploitation.map(statut => ({
          value: statut,
          label: statut
        }))}
      />
      <DynamicCheckbox
        small
        legend='Usages *'
        options={usagesExploitation.map(usage => ({
          value: usage,
          label: usage,
          nativeInputProps: {
            defaultChecked: usages.includes(usage),
            onChange: e => handleUsages(e, usage)
          }
        }))}
        orientation='horizontal'
      />
      <Input
        textArea
        label='Remarque'
        nativeTextAreaProps={{
          placeholder: 'Entrer une remarque',
          defaultValue: exploitation?.remarque,
          onChange: e => setExploitation(prev => ({...prev, remarque: e.target.value}))
        }}
      />
      <AccordionCentered
        isExpanded={isExpanded}
        setIsExpanded={setIsExpanded}
        label='la gestion des règles'
      >
        <ReglesForm defaultRegles={exploitation?.regles} setExploitation={setExploitation} />
      </AccordionCentered>
    </div>
  )
}

export default ExploitationForm
